<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<title>切换充电桩地址</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<link rel="stylesheet" href="../css/mui.min.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../plugins/layer/layer.js"></script>
    <script src="../js/artTemplate.min.js"></script>
    <script src="../js/base.js"></script>
    <script src="../js/common.js"></script>    
    <style type="text/css">
    	body{overflow: hidden;height: auto;}
    	.mui-plus .header-immersed{display:none;}
		.mui-plus .header-immersed .mui-content{padding:0;margin:0;}
		.mui-plus .header-immersed.mui-bar-nav{height:0;padding-top:0;}
		.mui-plus .header-immersed.mui-bar-nav ~ .mui-content{padding-top:0;}
		.mui-plus .header-immersed.mui-bar-nav ~ .mui-content .mui-pull-top-pocket{top:0;}
    	.yzc-main{margin: 0 20px;}
		.yzc-search{margin: 20px auto 0px;}
		.yzc-search input{height: 40px;font-size: 15px;text-align: left;}
		.mui-search .mui-placeholder{line-height: 40px;font-size:15px;text-align: left;}
		.mui-search .mui-placeholder .mui-icon{margin:10px 5px 0 5px;float:left;color:#a0a0a0;}	
		.dw-relocation{float: right;font-size: 12px;color: #FF6D22;}
		.dw-relocation i{padding-right: 5px;vertical-align: -1px;}
		.yzc-dw-text{border-bottom: 1px solid #C4C4C4;padding-bottom: 10px;}
		.near-cdz-title,.search-cdz-title{font-size: 15px;font-weight: 400;padding-top: 10px;color: #AFAFAF;}
		.mui-table-view:before,.mui-table-view:after{height: 0;}
		.list-cdz{list-style: none;padding: 10px 0;border-bottom: 1px solid #F0F0F0;color: #4D4D4D;}
		.list-cdz.active{color: #F97A1A;}
		.list-cdz em{color: #F97A1A;font-style: normal;}
		.icon-cdz{padding-right: 2px;}
		.icon-map{padding-right: 2px;}
    </style>
</head>
<body style="background: #fff;">
	<header class="header header-immersed mui-bar mui-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    	<h1 class="mui-title">切换充电桩地址</h1>
	</header>		
	<div class="mui-content" style="background: #fff;">
		<div class="yzc-main">
			<div class="search-box">
				<form id="searchForm">
					<div class="mui-input-row mui-search yzc-search">
						<input id="search" type="text" class="mui-input-clear" placeholder="请输入您要搜索的关键字">
					</div>
				</form>		
			</div>
			<div class="search-content">
				<h2 class="search-cdz-title hide">相关充电桩地址</h2>
				<ul class="mui-table-view" id="searchList"></ul>
			</div>
			<div class="yzc-cdz">
				<div class="yzc-dw-text">
					<span class="dw-title">加载中..</span>
					<span class="dw-relocation"><i class="iconfont icon-zhongxindingwei"></i>重新定位</span>
				</div>
				<div class="nearcdz-box">
					<h2 class="near-cdz-title"><i class="iconfont icon-cdz"></i>最近使用充电桩地址</h2>
					<ul class="mui-table-view" id="lastList"></ul>
				</div>
				<div class="nearcdz-box">
					<h2 class="near-cdz-title"><i class="iconfont icon-map"></i>附近充电桩地址</h2>
					<ul class="mui-table-view" id="itemList"></ul>
				</div>
			</div>
		</div>
	</div>
	<!--附近充电桩地址模板-->
	<script type="text/html" id="listTmpl" >	
		<!--<li class="list-cdz" data-id="389" onclick="selectChargingGroupAction(this)">太原市南内环街裕华苑</li>-->
		{{each list as item index}}
			{{if item.nameDisplay}}			
			<li class="list-cdz" data-id="{{item.code}}" onclick="selectChargingGroupAction(this)">{{#item.nameDisplay}}</li>
			{{else}}
			<li class="list-cdz" data-id="{{item.id}}" onclick="selectChargingGroupAction(this)">{{item.name}}</li>
			{{/if}}
		{{/each}}
	</script>
	<script src="../js/mui.min.js"></script>
	<script type="text/javascript">
		var $addressInfo = $("#addressInfo");
		//当前选择的片区
		var groupID   = null;
		//用户定位信息
		var geolocationGroup = {};
		//附近的片区
		var nearChargingGroupList = null;
		//上次使用的片区
		var lastUseChargingGroup = null;	
		mui.init();
		mui.plusReady(function(){
			plus.webview.currentWebview().setStyle({
				softinputMode: "adjustResize"
			});
			getAddress();
			getChargingGroupNearList();
		})	
		//获取定位地址
		function getAddress(){
			geolocationGroup = JSON.parse(plus.storage.getItem("geolocationGroup"));
			if(vaildeParam(geolocationGroup)){
				var addresses = geolocationGroup.addresses;
				setTimeout(function(){
					$('.dw-title').text(addresses);				
				},400);		
			}
		}
		$('.dw-relocation').on('tap',function(){
			$('.dw-title').text("定位中..");
			getCurrentPosition();
			getAddress();
			getChargingGroupNearList();
		});		
		/**
		 * 获取附近的片区
		 */
		function getChargingGroupNearList() {
			var uuid = plus.storage.getItem("uuid");
			if(!vaildeParam(geolocationGroup.longitude) || !vaildeParam(geolocationGroup.latitude)) {
				layer.msg("定位失败，请重新定位");
				return;
			}
			var param = {
				"uuid": uuid,
				"latitude": geolocationGroup.latitude,
				"longitude": geolocationGroup.longitude,
				"limit": 10
			}
			postJSON(API_URL.GetNearChargingGroup, param, function (res) {
				if("0" == res.code) {
					//附近的片区
					nearChargingGroupList = res.data.near;
					//上次使用的片区
					lastUseChargingGroup = res.data.recent;
					if(vaildeParam(lastUseChargingGroup)) {
						var data = {'list':lastUseChargingGroup};
						var Html = template('listTmpl', data);
						$('#lastList').html(Html);
					} else {
						$('#lastList').html('<p style="padding: 10px">暂无数据</p>');
					}
					if(vaildeParam(nearChargingGroupList)) {
						var data = {'list':nearChargingGroupList};
						var Html = template('listTmpl', data);
						$('#itemList').html(Html);
					} else {
						$('#itemList').html('<p style="padding: 10px">暂无数据</p>');
					}				
				} else {
					layer.msg(res.msg);
				}
			});
		}	
		/**
		 * 选择片区
		 * @param that
		 */
		function selectChargingGroupAction(that) {
			var $this = $(that);
			$this.addClass('active');
			groupID = $this.attr("data-id");
			var address = $this.text();
			plus.storage.setItem("chargingGroupId",groupID);
			plus.storage.setItem("addresses",address);
			returnWindow("selectChargeMethod.html");
		}
		$("#search").on("focus",function(){
			$(".yzc-cdz").hide();
		})
//		$("#search").on('input propertychange',function(){
//			doSearch();
//		})
		//搜索input监听
		document.getElementById("searchForm").onsubmit = function() {
			$("#search").blur();
			doSearch();
            //处理代码  
	        return false;  
	    }
		//搜索充电桩地址		
		var doSearch = function() {
			var keywords = document.getElementById("search").value;
			if(vaildeParam(keywords)){
				var params = {
					uuid:uuid,
					keywords:keywords,
					limit:10
				}
				postJSON(API_URL.SearchChargingGroup,params,function(res){
					if("0" == res.code){
						if(vaildeParam(res.data)) {
							var data = {'list':res.data};
							var Html = template('listTmpl', data);
							$('#searchList').html(Html);
							$('.search-cdz-title').removeClass('hide');
						} else {
							$('#searchList').html('<p style="padding: 10px">暂无数据</p>');
						}
					}else{
						layer.msg(res.msg);
					}
				});
			}else{
				$(".yzc-cdz").show();
			}
		}
	</script>
</body>
</html>