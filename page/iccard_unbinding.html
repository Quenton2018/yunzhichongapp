<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="misapplication-tap-highlight" content="no"/>
    <meta name="HandheldFriendly" content="true"/>
    <meta name="MobileOptimized" content="320"/>
    <title>我的IC卡</title>
    <link rel="stylesheet" href="../css/iconfont.css">
    <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
    <link rel="stylesheet" href="../css/bootstrap.min.css" type="text/css" charset="utf-8"/>
    <link rel="stylesheet" href="../plugins/layer/theme/default/layer.css" type="text/css" charset="utf-8"/>
    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../plugins/layer/layer.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/base.js"></script>

    <style type="text/css">
        .myContent {
    		height: 90%;
    	}
        .adBox{
            margin-top: 15px;
            height: 80%;
        }
        #unBingingBtn{
            display: block;
            width: 100%;
            margin-top: 15px;
        }

		.dataNormal {
			padding-top: 30px;
			font-size: 24px;
            color: #666666;
            line-height: 55px;
		}
		.dataNormal .left{
            float: left;
        }
        .dataNormal .left span{
            display: inline-block;
            margin-right: 10px;
        }
        .dataNormal .right {
            float: right;
        }
        .tips {
        	width: 80%;
        	padding-top: 60px;
        	margin: 0 auto;
        }
        .tips .left {
        	width: 40px;
        	float: left;
        }
        .tips .right {
        	float: left;
        	padding: 10px 10px 0;
        	font-size: 14px;
            color: #666666;
            line-height: 16px;
        	background-color: #F0F0F0;
        	border-radius: 3px;
        }
    </style>
</head>
<body>

    <header id="header2">
        <div class="headInner">
            <div class="left" id="back"  onclick="back()" ><img src="../img/app_back.png" /></div>
            <div class="right">&nbsp;</div>
            <div style="clear: both"></div>
        </div>
    </header>

    <div class="myContent" style="padding-top: 70px">
        <h1 class="pageBigTitle">解除绑定</h1>
		
		<div class="adBox">
	        <div class="dataNormal">
	            <div class="left">
	                <div class="detialInfo">
	                    <span class="span1">卡号</span>
	                </div>
	            </div>
	            <div class="right">
	            	<span class="span2" id="iccard"></span>
	            </div>
	            <div style="clear: both"></div>
	        </div>
	        
	        <div class="tips">
	        	<div class="left">
	        		<img src="../img/iccard/tip.png">
        		</div>
        		<div class="right">
        			<p>IC卡遗失则解除绑定</p>
        			<p>其它情况请慎重操作</p>
        		</div>
	        </div>
		</div>
        <img id="unBingingBtn" src="../img/iccard/unbinding.png">
    </div>

    <script type="application/javascript">    	
        
        var iccard = location.href;
        iccard = iccard.substring(iccard.lastIndexOf('#') + 1);
        if (/^[0-9]{10}$/.test(iccard)) {
        	$('#iccard').html(iccard);
        } else {
        	layer.msg('不识别的IC卡');
        }
    	
    	$(function() {
    		$('#unBingingBtn').click(function() {
    			plus.nativeUI.confirm('您确认解除与此卡的绑定？', unBingingConfirmed);
			});
			
			/*
			 * function(Event event) {
    				var index = event.index;
    				plus.nativeUI.alert(index);
    				
    				var uuid = plus.storage.getItem("uuid");
	    			if (vaildeParam(uuid)) {
		    			postJSON(API_URL.ApiMemberCardUnBindingCard, {
		    				"uuid": uuid,
		    				"iccard": iccard
		    			}, function(res) {
		    				if (res.code == '0') {
		    					layer.msg("解除绑定成功"+document.referrer, function() {
	    							location.href = 'iccard.html';
		    					});
		    				} else {
		    					layer.msg(res.msg);
		    				}
		    			});
	    			}
	    		}
			 */
			function unBingingConfirmed(event) {
				if (event.index == 1) {
					return;
				}
				
				var uuid = plus.storage.getItem("uuid");
    			if (vaildeParam(uuid)) {
	    			postJSON(API_URL.ApiMemberCardUnBindingCard, {
	    				"uuid": uuid,
	    				"iccard": iccard
	    			}, function(res) {
	    				if (res.code == '0') {
	    					layer.msg("解除绑定成功"+document.referrer, function() {
    							var ws=plus.webview.currentWebview();
			                    var wo = ws.opener();
			                    wo.evalJS('getList()');
			                    
			                    back();
	    					});
	    				} else {
	    					layer.msg(res.msg);
	    				}
	    			});
    			}
			}
    	});

        var ws=null;
        // 处理沉浸式状态栏
        var topoffset=0;
        var ms=(/Html5Plus\/.+\s\(.*(Immersed\/(\d+\.?\d*).*)\)/gi).exec(navigator.userAgent);
        if(ms&&ms.length>=3){
            topoffset=parseFloat(ms[2]);
        }

        if(window.plus){
            pagePlusReady();
        }else{
            document.addEventListener('plusready',pagePlusReady,false);
        }

        function pagePlusReady(){

            uploadLoginInfo();

            checkLogin();

            getUserInfo();

			// getMidBigPic();
			
            ws=plus.webview.currentWebview();
            if(plus.navigator.isImmersedStatusbar()){// 兼容沉浸式状态栏模式
                topoffset=Math.round(plus.navigator.getStatusbarHeight());
            }
            ws.setPullToRefresh({support:true,style:'circle',offset:topoffset+45+'px'},onRefresh);

        }

        // 刷新页面
        function onRefresh(){
            getUserInfo();
            ws.endPullToRefresh();
        }

        /**
         * 获取用户信息
         */
        function getUserInfo(){
            var uuid = plus.storage.getItem("uuid");
            if(vaildeParam(uuid)){
                postJSON(API_URL.ApiMemberInfo,{"uuid":uuid},function(res){
                    if("0" == res.code){
                        var money = res.data.totalMoney;
                        console.log("## money ## : "+money)
                        money= parseFloat(money);
                        money = parseFloat(money.toFixed(2));
                        $("#moneyBox").text(money);

                        var points = res.data.points;
                        if(!vaildeParam(points)){
                            points = 0;
                        }
                        console.log("## points ## : "+points)
                        points= parseFloat(points);
                        points = parseFloat(points.toFixed(2));
                        $("#pointsBox").text(points);


                    }else{
                        layer.msg(res.msg);
                        clearLogin();
                        clicked("page/login.html");
                    }
                })
            }
        }


        function getMidBigPic() {
            postJSON(API_URL.ApiCarouselImageGetCarouselImage,{},function(res){
                if("0" == res.code){
                    var data = res.data;
                    if(0 == data.length){
                        return;
                    }

                    var imgUrl = '';
                    $.each(data, function(index,item) {
                        if(1 == index){
                            imgUrl = item.pic;
                        }
                    });

                    loadImage(imgUrl,function () {
                        $(".midBigPic").attr("src",imgUrl);
                    })
                }else{
                    layer.msg(res.msg);
                }
            })
        }


    </script>


</body>

</html>