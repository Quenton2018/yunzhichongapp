<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
	<meta name="misapplication-tap-highlight" content="no"/>
	<meta name="HandheldFriendly" content="true"/>
	<meta name="MobileOptimized" content="320"/>
	<title>邀请好友</title>
	<link rel="stylesheet" href="../css/iconfont.css">
	<link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
	<link rel="stylesheet" href="../css/mui.min.css" type="text/css" charset="utf-8"/>
	<link rel="stylesheet" href="../css/bootstrap.min.css" type="text/css" charset="utf-8"/>
	<link rel="stylesheet" href="../plugins/layer/theme/default/layer.css" type="text/css" charset="utf-8"/>
	<!--引入公用样式-->
	<link rel="stylesheet" type="text/css" href="../css/public.css" />
	<script src="../js/jquery-3.3.1.min.js"></script>
	<script src="../js/mui.min.js"></script>
	<script src="../plugins/layer/layer.js"></script>
	<script src="../js/common.js"></script>
	<script src="../js/base.js"></script>


	<style type="text/css">
		#invitationBtn{
			display: block;
			width: 100%;
		}
		#invitation{
			width: 100%;
		}
		.my-Content{
			margin: 0 4rem;
		}
		.blockBtn{
			margin: 0 2rem;
		}
		.mui-btn-blue, .mui-btn-primary, input[type=submit] {
			color: #fff;
			border: none;
			background-color:  #fff;
		}
		.mui-popover{
			width: 100%;
			border-radius:0px;
		}
		/*移除底部或顶部三角,需要在删除此代码*/
		.mui-popover .mui-popover-arrow:after {
			width: 0px;
		}

		img { border:0; }

		ul { list-style: none outside none; margin:0; padding: 0; }

		body .mainmenu:after { clear: both; content: " "; display: block; }

		body .mainmenu li{
			float:left;
			margin-left: 2.5%;
			margin-top: 2.5%;
			width: 30%;
			border-radius:3px;
			overflow:hidden;
		}
		body .mainmenu li a{
			display:block;
			color:#FFF;
			text-align:center
		}
		body .mainmenu li a b{
			display:block;
			height:60px;
		}
		body .mainmenu li a img{
			margin-top: 5px;
			width: 50px;
			height: 50px;
		}

		.heard-body h4{
			font-size: 18px;
			text-align: center;
			margin-top: 10px;
			margin-bottom: 0px;
		}
		body .mainmenu li a span{
			display:block;
			height: 20px;
			line-height: 20px;
			/*color: #999;*/
			color:#232124;
			font-size:14px;
		}

		.mui-backdrop{
			z-index: 99998;
		}
		.mui-popover{
			z-index: 99999;
		}

		.dataBoxInner{
			box-shadow: 0px 3px 5px 5px RGBA(116, 116, 116, .1);
			padding: 10px;
			margin-bottom: 20px;
			border-radius: 10px;
		}
		.dataBoxInner .left{
			float: left;
		}
		.dataBoxInner .right{
			float: right;
		}
		.dataBoxInner .top{
			text-align: center;
			border-bottom: #F0F0F0 solid 1px;
			padding-bottom: 10px;
			margin-bottom: 10px;
		}
		.dataBoxInner .top .left{
			width: 50%;
		}
		.dataBoxInner .top .right{
			width: 50%;
		}
		.dataBoxInner .top .row1{
			color: #949494;
			padding-top: 10px;
		}
		.dataBoxInner .top .row2 span{
			color: #E26D42;
			font-size: 1.5rem;
			display: inline-block;
			margin-right: 5px;
		}

		.memberItem{
			margin-top: 15px;
		}
		.memberItem .left{
			position: relative;
			padding-left: 60px;
			color: #4C4C4C;
		}
		.memberItem .left .row1{
			padding-top: 5px;
		}
		.memberItem .left .row2{
			color: #D3D3D3;
			font-size: .8rem;
		}
		.memberItem .left img{
			position: absolute;
			left: 0;
			width: 50px;
			height: 50px;
			border-radius: 50%;
		}
		.memberItem .right{
			line-height: 50px;
			color: #373737;
			font-size: .9rem;
		}

        .qrcodeBox{
            text-align: center;
            margin: 0 auto;
        }
        .qrcodeBox img{
            display: block;
            margin: 0 auto;
        }
        .layui-layer-title{
            background: #fff;
        }
        .layui-layer{
            border-radius: 10px;
            overflow: hidden;
        }
        .noData{
            padding: 10px;
            text-align: center;
        }
        .loadMore{
            text-align: center;
            background: #fafafa;
            padding: 10px;
            font-size: .8rem;
            margin-top: 10px;
            display: none;
        }
	</style>
</head>
<body style="background: #fff;">
	<header id="header2">
		<div class="headInner">
			<div class="left" id="back"  onclick="back()" ><img src="../img/app_back.png" /></div>
			<div class="right">&nbsp;</div>
			<div style="clear: both"></div>
		</div>
	</header>

	<div class="topBox">
		<div>
			<div class="myContent" style="padding-top: 70px;">
				<h1 class="pageBigTitle">邀请有礼</h1>
			</div>
		</div>

		<div class="my-Content">
			<img id="invitation" src="../img/yaoqing/app_03.png" >
		</div>

		<div class="blockBtn">
			<a id="test" class="mui-btn mui-btn-primary mui-btn-block">
				<img id="invitationBtn" src="../img/yaoqing/app_07.png" >
			</a>
		</div>
	</div><!-- /.topBox -->

	<div class="dataBox" style="padding-bottom: 20px">
		<div class="dataBoxInner myContent">
			<div class="top">
				<div class="left">
					<div class="row1">成功邀请</div>
					<div class="row2"><span id="invitationCount">0</span>人</div>
				</div>
				<div class="right">
					<div class="row1">获得云钻</div>
					<div class="row2"><span id="givePoints">0</span>个</div>
				</div>
				<div style="clear: both"></div>
			</div>
			<div class="memberList">
                <div class="noData">加载中...</div>
			</div>
            <div class="loadMore">加载更多</div>
		</div>
	</div><!-- /.dataBox -->

	<div id="popover" class="mui-popover" style="height: 30%;position: fixed;bottom: 0;width: 100%">
		<div class="mui-popover-arrow"></div>
		<div class="heard-body">
			<h4>分享到</h4>
		</div>
		<div>
			<ul class="mainmenu">
				<li><a href="javascript:0" id="shareWxFriends" ><b><img src="../img/yaoqing/app_wx.png" /></b><span>微信</span></a></li>
				<li><a href="javascript:0" id="shareWxTimeline"><b><img src="../img/yaoqing/app_wxpy.png" /></b><span>微信朋友圈</span></a></li>
				<!--<li><a href="javascript:0" ><b><img src="../img/yaoqing/app_qq.png" /></b><span>QQ</span></a></li>-->
				<!--<li><a href="javascript:0" ><b><img src="../img/yaoqing/app_qqkj.png" /></b><span>QQ空间</span></a></li>-->
				<!--<li><a href="javascript:0" ><b><img src="../img/yaoqing/app_fulj.png" /></b><span>复制链接</span></a></li>-->
				<li><a href="javascript:0" id="showQrcode" ><b><img src="../img/yaoqing/app_mdm.png" /></b><span>面对面邀请</span></a></li>
			</ul>
		</div>
	</div>

</body>

<script type="text/html" id="tmplData">
    <div class="memberItem">
        <div class="left">
        <img src="{{headImage}}">
        <div class="row1">{{mobile}}</div>
        <div class="row2">{{createDate}}</div>
    </div>
    <div class="right">
        {{orderStatus}}
        </div>
        <div style="clear: both"></div>
    </div>
</script>

<script src="../js/qrcode.min.js" ></script>
<script type="text/javascript" charset="utf-8">
    mui.init();

    var shares = null;
    var shareUrl = null;

    var defaultAvator = '../img/user_profile/app_10.png'; //默认头像

    var pageNumber = 1;
    var pageSize = 10;

    /**
     * 更新分享服务
     */
    function updateSerivces(){
        plus.share.getServices(function(s){
            shares={};
            for(var i in s){
                var t=s[i];
                shares[t.id]=t;
            }
        }, function(e){
            console.log('获取分享服务列表失败：'+e.message);
        });
    }

    if(window.plus){
        pagePlusReady();
    }else{
        document.addEventListener('plusready',pagePlusReady,false);
    }


    /**
     * 获取邀请统计数据
     */
    function getInvitationStatistics() {

        var uuid = plus.storage.getItem("uuid");
        if(vaildeParam(uuid)){
            postJSON(API_URL.ApiInvitationLogGetInvitationStatistics,{"uuid":uuid},function(res){
                if("0" == res.code){
                    var invitationCount = res.data.invitationCount;
                    var givePoints = res.data.givePoints;

                    $("#invitationCount").text(invitationCount);
                    $("#givePoints").text(givePoints);
                }else{
                    layer.msg(res.msg);
                    clearLogin();
                }
            })
        }
    }

    function getDataList() {

        var uuid = plus.storage.getItem("uuid");
        postJSON(API_URL.ApiInvitationLogGetInvitationList,{"uuid":uuid,"pageNumber":pageNumber,"pageSize":pageSize},function(res){
            if("0" == res.code){
                var $memberList = $(".memberList");

                var totalElements = res.data.pagedata.totalElements;
                if(totalElements == 0){
                    $memberList.html('<div class="noData">暂无数据</div>')
                }

                if(1 == pageNumber){
                    $memberList.html("");
                }

                var content =  res.data.pagedata.content;

                var html = '';
                var tmplData = $("#tmplData").html();
                $.each(content,function (index,item) {

                    var orderStatus = '用户未充电';
                    if(item.orderFlag){
                        orderStatus = '用户已充电';
                    }

                    var headImage = vaildeParam(item.beInvitationMember.headImage)?item.beInvitationMember.headImage:defaultAvator;
                    console.log(headImage)
                    html += tmplData.replace(/{{mobile}}/g,item.beInvitationMember.mobile)
                        .replace(/{{headImage}}/g,headImage)
                        .replace(/{{createDate}}/g,new Date(item.createDate).format("yyyy-MM-dd"))
                        .replace(/{{orderStatus}}/g,orderStatus)
                })

                $memberList.append(html);

                if( res.data.pagedata.last){
                    $(".loadMore").css("display",'none');
                }else{
                    $(".loadMore").css("display",'block');
                }

            }else{
                layer.msg(res.msg);
                clearLogin();
            }
        })

    }
    

    function pagePlusReady(){

        uploadLoginInfo();

        updateSerivces();

        getInvitationStatistics();

        getDataList();

        var mobile = plus.storage.getItem("mobile");
        shareUrl = PAGE_URL.INVITATION+"?mobile="+mobile;

        document.getElementById("test").addEventListener("tap", function() {
            //调用隐藏/显示弹出层
            mui("#popover").popover('toggle', document.getElementById("div"));
        });

        $("#showQrcode").click(function () {
            var id = 'Qrcode_' + randomString(20);
            layer.open({
                title: '扫一扫'
                ,content: '<div class="qrcodeBox" style="width: 200px;height: 200px" id="'+id+'"></div>',
                btn:{}
            });

            var qrcode = new QRCode(document.getElementById(id), {
                width : 200,
                height : 200
            });
            qrcode.makeCode(shareUrl);
        })

        $("#shareWxTimeline").click(function () {
            shareAction({title:'微信朋友圈',s:shares['weixin'],x:'WXSceneTimeline'})
        })
        $("#shareWxFriends").click(function () {
            shareAction({title:'微信好友',s:shares['weixin'],x:'WXSceneSession'})
        })
    }

    
    function outLine(msg) {
        console.log("outLine"+msg);
    }

    function shareAction(sb) {
        console.log('分享操作：');
        if(!sb||!sb.s){
            outLine('无效的分享服务！');
            return;
        }
        var msg={content:"安全充电，即停即充，共享充电云智充",extra:{scene:sb.x}};
        msg.href = shareUrl;

        if(sb.x == 'WXSceneTimeline'){
            msg.title = "安全充电，即停即充，共享充电云智充";
		}else{
            msg.title = "云智充欢迎您加入";
        }

        msg.thumbs = ['../img/logo_big.png'];
        msg.pictures = ['../img/logo_big.png'];

        // 发送分享
        if(sb.s.authenticated){
            outLine('---已授权---');
            shareMessage(msg, sb.s);
        }else{
            outLine('---未授权---');
            sb.s.authorize(function(){
                shareMessage(msg,sb.s);
            }, function(e){

                if(-8 == e.code){
                    layer.msg("您的手机未安装微信,请先安装微信");
				}else{
                    layer.msg(e.message);
                }

                outLine('认证授权失败：'+e.code+' - '+e.message);
            });
        }
    }

    function shareMessage(msg, s){
        outLine(JSON.stringify(msg));
        s.send(msg, function(){
            outLine('分享到"'+s.description+'"成功！');
        }, function(e){
            outLine('分享到"'+s.description+'"失败: '+JSON.stringify(e));
        });
    }
</script>

</html>
