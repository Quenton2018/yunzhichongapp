<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<title></title>
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
	<meta name="misapplication-tap-highlight" content="no"/>
	<meta name="HandheldFriendly" content="true"/>
	<meta name="MobileOptimized" content="320"/>
	<link rel="shortcut icon" href="../favicon.ico">
	<link rel="stylesheet" href="../css/mui.min.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../plugins/layer/layer.js"></script>
    <script src="../js/mui.min.js"></script>
    <script src="../js/fastclick.js"></script>
	<script src="../js/artTemplate.min.js"></script>
    <script src="../js/base.js"></script>
    <script src="../js/common.js"></script>  
    <style type="text/css">
		.mui-table-view-cell{padding: 15px 15px;}
		.list-name{font-size: 16px;color: #444;}
		.list-desc{font-size: 12px;color: #777;}
		.mui-navigate-right{font-size: 24px;}
		.mui-bar .mui-btn-link{color: #fff;display: block;}
    </style>
</head>
<body>
	<header class="header header-immersed mui-bar mui-bar-nav">
		<a class="mui-go-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    	<h1 class="mui-title">蓝牙测试</h1>
	</header>
	<div class="mui-content">
		<ul class="mui-table-view">
			<li class="mui-table-view-cell"><button onclick="createConnection()">连接蓝牙设备</button></li>
			<li class="mui-table-view-cell"><button onclick="closeConnection()">断开蓝牙设备</button></li>
			<li class="mui-table-view-cell"><button onclick="getServices()">获取蓝牙设备的所有服务</button></li>
			<li class="mui-table-view-cell"><button onclick="getCharacteristics()">获取蓝牙设备指定服务中所有特征值</button></li>
			<li class="mui-table-view-cell"><button onclick="writeCharacteristics()">写入低功耗蓝牙设备的特征值</button></li>
			<li class="mui-table-view-cell"><button onclick="readCharacteristics()">读取低功耗蓝牙设备的特征值</button></li>
			<li class="mui-table-view-cell"><button onclick="startCharacteristicsNotify()">启用低功耗蓝牙设备特征值变化时的notify功能</button></li>
		</ul>
	</div>
	<script type="text/javascript">
		mui.init();
		mui.plusReady(function () {
		    openBluetoothAdapter();
		})
		
		// 打开蓝牙模块
		function openBluetoothAdapter(){
			plus.bluetooth.openBluetoothAdapter({
				success:function(e){
					console.log('open success: '+JSON.stringify(e));
				},
				fail:function(e){
					console.log('open failed: '+JSON.stringify(e));
				}
			});
// 			listenerDeviceFound();
// 			startBluetoothDiscovery();
			
		}
		// 监听发现新设备
		function listenerDeviceFound(){
			plus.bluetooth.onBluetoothDeviceFound(function(e){
				var devices = e.devices;
				console.log('device found: '+e.length);
				for(var i in devices){
					console.log(i+': '+JSON.stringify(devices[i]));
				}
			});
		}
		// 开始搜索蓝牙
		function startBluetoothDiscovery(){
			plus.bluetooth.openBluetoothAdapter({
				success:function(e){
					console.log('open success: '+JSON.stringify(e));
					plus.bluetooth.startBluetoothDevicesDiscovery({
						success:function(e){
							console.log('start discovery success: '+JSON.stringify(e));
						},
						fail:function(e){
							console.log('start discovery failed: '+JSON.stringify(e));
						}
					});
				},
				fail:function(e){
					console.log('open failed: '+JSON.stringify(e));
				}
			});
		}
		// var deviceId = 'D9:09:A7:5A:45:90';
		var deviceId = 'D49A570D-44F6-EC37-71B1-5F52A07866BB';
		// 连接蓝牙设备
		function createConnection(){
			plus.bluetooth.createBLEConnection({
				deviceId:deviceId,
				success:function(e){
					console.log('create connection success: '+JSON.stringify(e));
				},
				fail:function(e){
					console.log('create connection failed: '+JSON.stringify(e));
				}
			});
		}
		
		// 断开蓝牙设备
		function closeConnection(){
			plus.bluetooth.closeBLEConnection({
				deviceId:deviceId,
				success:function(e){
					console.log('close success: '+JSON.stringify(e));
				},
				fail:function(e){
					console.log('close failed: '+JSON.stringify(e));
				}
			});
		}
		
		// 获取蓝牙设备的所有服务
		function getServices(){
			plus.bluetooth.getBLEDeviceServices({
				deviceId:deviceId,
				success:function(e){
					var services = e.services;
					console.log('get services success: '+services.length);
					for(var i in services){
						console.log(i+': '+JSON.stringify(services[i]));
					}
				},
				fail:function(e){
					console.log('get services failed: '+JSON.stringify(e));
				}
			});
		}
		
		var serviceId = '0000FFF0-0000-1000-8000-00805F9B34FB';
		
		// 获取蓝牙设备指定服务中所有特征值
		function getCharacteristics(){
			plus.bluetooth.getBLEDeviceCharacteristics({
				deviceId:deviceId,
				serviceId:serviceId,
				success:function(e){
					var characteristics = e.characteristics;
					console.log('get characteristics success: '+characteristics.length);
					for(var i in characteristics){
						console.log(i+': '+JSON.stringify(characteristics[i]));
					}
				},
				fail:function(e){
					console.log('get characteristics failed: '+JSON.stringify(e));
				}
			});
		}
		
		var characteristicId = '0000FFF1-0000-1000-8000-00805F9B34FB'; // write notify
		// characteristicId = '0000FFF3-0000-1000-8000-00805F9B34FB'; // write read
		var value = new ArrayBuffer(8);
		var iv = new Int32Array(value);
		iv[0] = 120, iv[1] = 100;
		
		// 写入低功耗蓝牙设备的特征值
		function writeCharacteristics(){
			plus.bluetooth.writeBLECharacteristicValue({
				deviceId:deviceId,
				serviceId:serviceId,
				characteristicId:characteristicId,
				value:value,
				success:function(e){
					console.log('write characteristics success: '+JSON.stringify(e));
				},
				fail:function(e){
					console.log('write characteristics failed: '+JSON.stringify(e));
				}
			});
		}
		
		// 读取低功耗蓝牙设备的特征值
		function readCharacteristics(){
			plus.bluetooth.readBLECharacteristicValue({
				deviceId:deviceId,
				serviceId:serviceId,
				characteristicId:characteristicId,
				success:function(e){
					console.log('read characteristics success: '+JSON.stringify(e));
				},
				fail:function(e){
					console.log('read characteristics failed: '+JSON.stringify(e));
				}
			});
		}
		
		// 启用低功耗蓝牙设备特征值变化时的notify功能
		function startCharacteristicsNotify(){
			// 监听低功耗蓝牙设备的特征值变化 
			plus.bluetooth.onBLECharacteristicValueChange(function(e){
				console.log('onBLECharacteristicValueChange: '+JSON.stringify(e));
				/* var value = buffer2hex(e.value);
				console.log('value(hex) = '+value); */
				if(characteristicId == e.characteristicId){
					// 更新到页面显示
					alert('特征值变化: '+value);
				}
			});
			// 启用notify功能
			plus.bluetooth.notifyBLECharacteristicValueChange({
				deviceId:deviceId,
				serviceId:serviceId,
				characteristicId:characteristicId,
				success:function(e){
					var characteristics = e.characteristics;
					console.log('get characteristics success: '+characteristics);
					for(var i in characteristics){
						console.log(i+': '+JSON.stringify(characteristics[i]));
					}
				},
				fail:function(e){
					console.log('get characteristics failed: '+JSON.stringify(e));
				}
			});
		}
	</script>
</body>
</html>