<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
		<meta name="misapplication-tap-highlight" content="no"/>
		<meta name="HandheldFriendly" content="true"/>
		<meta name="MobileOptimized" content="320"/>
		<title>选择插座</title>
		<link rel="stylesheet" href="../css/iconfont.css">
		<link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
		<link rel="stylesheet" href="../css/bootstrap.min.css" type="text/css" charset="utf-8"/>
		<link rel="stylesheet" href="../plugins/layer/theme/default/layer.css" type="text/css" charset="utf-8"/>
		<script src="../js/jquery-3.3.1.min.js"></script>
		<script src="../js/bootstrap.min.js"></script>
		<script src="../plugins/layer/layer.js"></script>
		<script src="../js/hammer.min.js"></script>
		<script src="../js/jquery.hammer.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/base.js"></script>
		
		<style type="text/css">
			
			.chargingSocket{
				width: 100%!important;
				background: #fff;
				bottom: 0!important;
				border-top:#CECECE solid 1px ;
			}
			.chargingSocket span{
				display: block;
				float: left;
				width: 16.66%;
				text-align: center;
				padding: 10px 0;
				z-index: 10000;
				background: #fff;
			}
			.chargingSocket span.danger{
				color: red;
			}
			.chargingSocket span.selected{
				color: #009966;
				font-weight: bold;
			}
			.chargingSocket span i{
				display: block;
				font-size: 2.3rem;
				margin: 0 auto;
			}
			.list-group-item{
				padding: 0 10px;
				line-height: 3rem;
				position: relative;
				padding-left: 40px;
			}
			.list-group span{
				float: right;
				font-size: 1rem;
				font-weight: 400;
				line-height: 3rem;
			}
			.list-group .iconfont{
				font-size: 1.5rem;
				position: absolute;
				left: 10px;
				color: #009966;
				display: none;
			}
			.list-group li.selected .iconfont{
				display: block;
			}
			.chargingBtn{
				margin: 2rem;
				background: #54C3FF;
				color: #fff;
				line-height: 3rem;
				border-radius:5px;
				margin-bottom: 1rem;
				margin-top: 1rem;
			}
		</style>
	</head>
	<body style="background: #EFEFF4;">
		<header id="header">
			<div class="nvbt" onclick="back()"><i class="iconfont icon-fanhui"></i></div>
			<div class="nvtt">选择插座</div>
		</header>
		<div id="content" class="content">
			<div class="chargingSocket" id="chargingSocketBox">
				
			</div>
			<div style="clear: both;"></div>
			<div class="priceBox" style="margin-top: 10px;">
				<ul class="list-group" style="text-align: left;border-radius: 0;">
				</ul>
			</div>
			
			<div class="chargingBtn">开始充电</div>
			
			
		</div>
	
	<script type="application/javascript">
		if(window.plus){
			pagePlusReady();
		}else{
			document.addEventListener('plusready',pagePlusReady,false);
		}
		
		function pagePlusReady(){
			getChargingSocketList();
			getChargingGroupPrice();
		}
		
		function compare(property){
		    return function(a,b){
		        var value1 = parseFloat(a[property]);
		        var value2 = parseFloat(b[property]);
		        return value1 - value2;
		    }
		}
		
		/**
		 * 获取所有插座
		 */
		function getChargingSocketList(){
			var currentChargingCode = plus.storage.getItem( "currentChargingCode");
			
			console.log(" ## getChargingSocketList ## currentChargingCode : " + currentChargingCode)
			
			if(!vaildeParam(currentChargingCode)){
				clicked("./selectChargeMethod.html");
				return;
			}
			
			postJSON(API_URL.ApiChargingSocketListByCode,{"code":currentChargingCode},function(res){
				if("0" == res.code){
					
					var tmpl1 = '<span class="danger" data-id="{{id}}"><i class="iconfont icon-hekriconshebeizhuijiachazuoyuanxian"></i>{{code}}</span>';
					var tmpl2 = '<span class="item" data-id="{{id}}"><i class="iconfont icon-hekriconshebeizhuijiachazuoyuanxian"></i>{{code}}</span>';
					var data = res.data;
					
					data = data.sort(compare('code'));
					
					var res = '';
					$.each(data, function(inedx,item) {
						var tmplTmp = tmpl1;
						if(1 == item.status){
							tmplTmp = tmpl2;
						}
						res += tmplTmp.replace(/{{id}}/g,item.id).replace(/{{code}}/g,parseInt(item.code) + 1);
					});
					$("#chargingSocketBox").html(res);
					bindSelectChargingSocket();
				}else{
					layer.msg(res.msg);
				}
			})
				
			
		}
		
		function bindSelectChargingSocket(){
			$("#chargingSocketBox .item").bind('click',function(){
				$("#chargingSocketBox .item").removeClass('selected');
				$(this).addClass('selected');
			})
		}
		
		function getChargingGroupPrice(){
			var currentChargingCode = plus.storage.getItem( "currentChargingCode");
			if(!vaildeParam(currentChargingCode)){
				clicked("./selectChargeMethod.html");
				return;
			}
			
			postJSON(API_URL.ApiCharginGetPriceListByChargingCode,{"code":currentChargingCode},function(res){
				if("0" == res.code){
					var tmpl = '<li class="list-group-item" data-id="{{id}}"><i class="iconfont icon-quangou"></i> {{hour}}小时 ';
					tmpl += '<span class="badge">{{money}}元</span></li>';
					var data = res.data;
					var res = '';
					$.each(data, function(inedx,item) {
						
						var minute = item.defaultTime;
						var hours = minute/60;
						hours = parseFloat(hours.toFixed(2)); 
						res += tmpl.replace(/{{id}}/g,item.id).replace(/{{money}}/g,item.price).replace(/{{hour}}/g,hours);
					});
					$(".priceBox ul").html(res);
					bindSelectPrice();
				}else{
					layer.msg(res.msg);
				}
			})
				
		}
		
		function bindSelectPrice(){
			$(".priceBox li").bind('click',function(){
				$(".priceBox li").removeClass('selected');
				$(this).addClass('selected');
			})
		}
		
		
		$(".chargingBtn").click(function(){
			var $socket = $("#chargingSocketBox .selected");
			if($socket.length == 0){
				layer.msg("请选择一个插头");
				return;
			}
			var socketID = $socket.attr("data-id");
			
			var $price = $(".priceBox li.selected");
			if($price.length == 0){
				layer.msg("请选择充电时长");
				return;
			}
			var priceID = $price.attr("data-id");

			var uuid = plus.storage.getItem( "uuid");
			
			var data = {
				"uuid":uuid,
				"zcID":socketID,
				"chargingGroupPriceId":priceID
			}
			postJSON(API_URL.ApiDeviceCommandSendChargeCommand,data,function(res){
				if("0" == res.code){
					layer.msg("充电成功,正在充电");
					clicked("chargingNowList.html");
				}else{
					layer.msg(res.msg);
				}
			})
		})
		
	</script>
		
	</body>

</html>