
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hello MUI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="stylesheet" href="../css/mui.min.css">

    <style>

        .mui-media-body{
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .mui-table-view:before{
            background: transparent;
        }
        .mui-table-view:after{
            background: transparent;
        }
    </style>
</head>

<body>

<!--下拉刷新容器-->
<div id="pullrefresh" class="mui-content mui-scroll-wrapper" style="padding-top: 30px;background: #EDEDED;">
    <div class="mui-scroll">
        <!--数据列表-->
        <div class="mui-table-view mui-table-view-chevron" id="dataBox">

        </div>
    </div>
</div>
<!--  <div class="mui-table-view-cell mui-media" data-id="{{id}}" onclick="itemClick(this)" style="position: relative">-->
<script type="text/html" id="dataTmpl">
    <div class="mui-table-view-cell mui-media" data-id="{{id}}" style="position: relative ;">
        <span style="position: absolute;right: 10px;font-size: .8rem;line-height: 60px;">{{date}}</span>
        <div class="mui-media-body">
            <h1 style="line-height: 25px;font-size: 1.0rem;color: #444">{{title}}</h1>
            <p class="mui-ellipsis">{{messageContent}}</p>
        </div>
        <div style="clear: both;"></div>
    </div>

</script>

<script src="../js/jquery-3.3.1.min.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../plugins/layer/layer.js"></script>
<script src="../js/common.js"></script>
<script src="../js/base.js"></script>
<script>

    var g_page = 1;
    var g_pageSize = 10;
    var $dataBox = $("#dataBox");



    if(window.plus){
        pagePlusReady();
    }else{
        document.addEventListener('plusready',pagePlusReady,false);
    }

    function pagePlusReady() {

        uploadLoginInfo();

        mui.init({
            pullRefresh: {
                container: '#pullrefresh',
                down: {
                    //callback: pulldownRefresh       //上拉刷新  因为android 样式问题 先去掉
                },
                up: {
                    contentrefresh: '正在加载...',
                    callback: pullupRefresh
                }
            }
        });
        pulldownRefresh();
    }


    function loadData(page,callback,isClear) {
        var uuid = plus.storage.getItem("uuid");

        var api = API_URL.ApiMessageGetMessageList;
        var data = {
            'uuid':uuid,
            'type':'common',
            'pageNumber':page,
            'pageSize':g_pageSize
        }

        postJSON(api,data,function (res) {
            if("0" == res.code){

                if(isClear){
                    $dataBox.html('');
                }
                if(res.data.pagedata.lastPage){
                    //加载完毕
                    mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
                }else{
                    mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
                }
                var html = '';
                var dataTmpl = $("#dataTmpl").html();
                $.each(res.data.pagedata.content,function (index,item) {
                    //var memberArray = eval(item.member);
                    var title  = item.title;
                    if(null==title){
                        title = '系统管理员'
                    }
                    var createDate = jsDateDiff(item.createDate / 1000);
                    var messageContent =  item.content;

                    html += dataTmpl.replace(/{{title}}/g,title)
                        .replace(/{{id}}/g,item.id)
                        .replace(/{{messageContent}}/g,messageContent)
                        .replace(/{{date}}/g,createDate)
                })
                $dataBox.append(html);
                if(null != callback){
                    callback(res);
                }
            }else{
                layer.msg(res.msg);
            }
        })

    }

    /**
     * 下拉刷新具体业务实现
     */
    function pulldownRefresh() {
        console.log("## pulldownRefresh ##")
        g_page = 1;
        loadData(1,null,true);
        mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
    }

    /**
     * 上拉加载具体业务实现
     */
    function pullupRefresh() {
        console.log("## pullupRefresh ##")
        g_page++;
        loadData(g_page,null,false);
    }

    function itemClick(that) {

        console.log("## itemClick ##")

        var $this = $(that);
        var id = $this.attr("data-id")
        console.log("id:"+id);
        clickedTwo("../page/messageContent.html",id+"");
    }

    function clickedTwo(item,dataId){
        console.log(item+":"+dataId);
        plus.storage.setItem( "messageId", dataId+"");
        clicked(item);
    }

   
</script>
</body>

</html>