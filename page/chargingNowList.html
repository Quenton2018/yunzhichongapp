<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
		<meta name="misapplication-tap-highlight" content="no"/>
		<meta name="HandheldFriendly" content="true"/>
		<meta name="MobileOptimized" content="320"/>
		<title>正在充电</title>
		<link rel="stylesheet" href="../css/iconfont.css">
		<link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
		<link rel="stylesheet" href="../css/bootstrap.min.css" type="text/css" charset="utf-8"/>
		<link rel="stylesheet" href="../plugins/layer/theme/default/layer.css" type="text/css" charset="utf-8"/>
		<script src="../js/jquery-3.3.1.min.js"></script>
		<script src="../js/bootstrap.min.js"></script>
		<script src="../plugins/layer/layer.js"></script>
		<script src="../js/hammer.min.js"></script>
		<script src="../js/jquery.hammer.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/base.js"></script>
		
		<style type="text/css">
			.dataList{
				
			}
			.dataList .dataItem{
				position: relative;
				background: #fff;
				margin-bottom: 5px;
				padding: 10px;
				padding-left: 90px;
			}
			.dataList .dataItem .code{
				position: absolute;
				left: 10px;
				height: 70px;
				width: 70px;
				border-radius:70%;
				background: #FDA639;
				line-height: 70px;
				color: #fff;
			}
			.dataList .dataItem .infoBox{
				text-align: left;
				font-size: .9rem;
				line-height: 24.5px;
			}
			.dataList .dataItem .row1{
				white-space: nowrap;
				text-overflow: ellipsis;
				overflow: hidden;
				width: 100%;
				padding-right: 10px;
			}
		</style>
	</head>
	<body style="background: #EFEFF4;">
		<header id="header">
			<div class="nvbt" onclick="back()"><i class="iconfont icon-fanhui"></i></div>
			<div class="nvtt">正在充电</div>
			<div class="nvbt" id="selectChargeMethod.html" onclick="clicked(this.id)"><i class="iconfont icon-jia1"></i></div>
		</header>
		<div id="content" class="content">
			<div class="dataList">
				
			</div>
		</div>
		
		<script type="text/html" id="dataTmpl">
			<div class="dataItem">
				<div class="code">{{code}}号</div>
				<div class="infoBox">
					<div class="row1">分组 : {{groupName}}</div>
					<div class="row2">状态 : {{status}}</div>
					<div class="row3 timeRow" data-create="{{createDate}}">时长 : <b>{{time}}</b></div>
				</div>
			</div>
		</script>
		
		<script type="application/javascript">
			
			var ws=null;
			// 处理沉浸式状态栏
			var topoffset=0;
			var ms=(/Html5Plus\/.+\s\(.*(Immersed\/(\d+\.?\d*).*)\)/gi).exec(navigator.userAgent);
			if(ms&&ms.length>=3){
				topoffset=parseFloat(ms[2]);
			}
			
			if(window.plus){
				pagePlusReady();
			}else{
				document.addEventListener('plusready',pagePlusReady,false);
			}
			
			function pagePlusReady(){
				getDoingList();
				
				ws=plus.webview.currentWebview();
				if(plus.navigator.isImmersedStatusbar()){// 兼容沉浸式状态栏模式
					topoffset=Math.round(plus.navigator.getStatusbarHeight());
				}
				ws.setPullToRefresh({support:true,style:'circle',offset:topoffset+45+'px'},onRefresh);
			}
			
			// 刷新页面
			function onRefresh(){
				getDoingList();
				ws.endPullToRefresh();
			}
			
			function getDoingList(){
				var uuid = plus.storage.getItem("uuid");
				if(vaildeParam(uuid)){
					postJSON(API_URL.ApiUserChargingDetailGetDoingList,{"uuid":uuid},function(res){
						if("0" == res.code){
							
							var data = res.data;
							var tmpl = $("#dataTmpl").html();
							var html = '';
							$.each(data, function(index,item) {
								
								var code = parseInt(item.czId.code) + 1 ;
								var groupName = item.czId.cdzId.groupId.name;
								var status = '正在充电';
								if(item.status == 2){
									status = '充电结束';
								}

								html += tmpl.replace(/{{code}}/g,code)
										.replace(/{{groupName}}/g,groupName)
										.replace(/{{status}}/g,status)
										.replace(/{{createDate}}/g,item.createDate)
										.replace(/{{time}}/g,getTimeDiff(item.createDate));

							});
							
							$(".dataList").html(html);
						
							
						}else{
							layer.msg(res.msg);
						}
					})
				}
			}
			
			
			
			setInterval(function(){
				var $timeRows = $(".timeRow");
				$.each($timeRows, function(index,item) {
					var createDate = $(item).attr("data-create");
					$(this).find("b").html(getTimeDiff(createDate))
				});
			},1000)
			
			
		</script>
		
	</body>

</html>