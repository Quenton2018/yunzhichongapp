<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
		<meta name="HandheldFriendly" content="true"/>
		<meta name="MobileOptimized" content="320"/>
		<title>扫一扫</title>
		<script src="../js/jquery-3.3.1.min.js"></script>
		<script src="../js/mui.min.js"></script>
		<script src="../js/fastclick.js"></script>
		<script src="../js/base.js"></script>
		<script src="../js/common.js"></script>
		<link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
		<style type="text/css">
			#bcid{width:100%;position:absolute;top:0px;bottom:0;text-align:center;}
			.tip{color:#FFFFFF;font-weight:bold;}
			iframe{width: 100%;height: 100%;}
		</style>
		<script type="text/javascript">
			var ws=null,wo=null;
			var scan=null,domready=false;
			if(window.plus){
				plusReady();
			}else{
				document.addEventListener('plusready', plusReady, false);
			}
			// 监听DOMContentLoaded事件
			document.addEventListener('DOMContentLoaded', function(){
				domready=true;
				plusReady();
			}, false);
			// H5 plus事件处理
			function plusReady(){			
				if(ws||!window.plus||!domready){
					return;
				}
				var formpage = plusUtils.appPage.getParam("formpage");
				mui.init({  
			        subpages: [{  
		                url: 'scanSub.html',  
		                id: 'scanSub.html',  
		                styles: {  
		                    top: 0,  
		                    bottom: 0,  
		                    background: 'transparent'  
		                },
		                extras:{
		                	formpage:formpage
		                }
		            }]  
			    });
				var typeArr = new Array();
				typeArr.push(plus.barcode.QR);
				typeArr.push(plus.barcode.EAN13);
				typeArr.push(plus.barcode.EAN8);
				typeArr.push(plus.barcode.CODE39);
				typeArr.push(plus.barcode.CODE93);
				typeArr.push(plus.barcode.CODE128);	
				var styles = {frameColor: "#F87C1A",scanbarColor: "#F87C1A"};
				
				// 获取窗口对象
				ws = plus.webview.currentWebview();
				wo = ws.opener();
				// 开始扫描
				ws.addEventListener('show', function(){
					scan=new plus.barcode.Barcode('bcid',typeArr,styles);
				    scan.onmarked=onmarked;
				    scan.start({conserve:true,filename:'_doc/barcode/',vibrate:true,sound:'default'});
				}, false);
				// 显示页面
			    ws.show('slide-in-bottom');
			}
							
			// 二维码扫描成功
			function onmarked(type, result, file){
			    switch(type){
			    	case plus.barcode.QR:
			    		type = 'QR';
			    		break;
			    	case plus.barcode.EAN13:
			    		type = 'EAN13';
			    		break;
			    	case plus.barcode.EAN8:
			    		type = 'EAN8';
			    		break;
			    	case plus.barcode.AZTEC:
			    		type = 'AZTEC';
			    		break;
			    	case plus.barcode.DATAMATRIX:
			    		type = 'DATAMATRIX';
			    		break;
			    	case plus.barcode.UPCA:
			    		type = 'UPCA';
			    		break;
			    	case plus.barcode.UPCE:
			    		type = 'UPCE';
			    		break;
		    		case plus.barcode.CODABAR:
			    		type = 'CODABAR';
			    		break;
		    		case plus.barcode.CODE39:
			    		type = 'CODE39';
			    		break;
		    		case plus.barcode.CODE93:
			    		type = 'CODE93';
			    		break;
		    		case plus.barcode.CODE128:
			    		type = 'CODE128';
			    		break;
			    	default:
			    		type = '其它'+type;
			    	break;
			    }
			    result = result.replace(/\n/g, '');
			    wo.evalJS("scaned('"+ type +"','"+ result +"','"+ file +"');");
			    back();
			}
			var bFlash = false;
			//开启手电筒
			function switchFlash(){
				bFlash = !bFlash;
				scan.setFlash(bFlash);		
			}
		</script>
	</head>
	<body style="background-color: #000000;">
		<div id="bcid">
			<div style="height:40%"></div>
			<p class="tip">...载入中...</p>
		</div>
	</body>
</html>
