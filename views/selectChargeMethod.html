<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
		<title>充电</title>
		<link rel="shortcut icon" href="../favicon.ico">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />	
		<link rel="stylesheet" href="../plugins/layer/theme/default/layer.css" type="text/css" charset="utf-8" />
		<link rel="stylesheet" href="../plugins/swiper-4.2.2/swiper-4.2.2.min.css" type="text/css" charset="utf-8" />
		<script src="../js/jquery-3.3.1.min.js"></script>
		<script src="../js/mui.min.js"></script>
		<script src="../js/artTemplate.min.js"></script>
		<script src="../plugins/layer/layer.js"></script>
		<script src="../plugins/swiper-4.2.2/swiper-4.2.2.min.js"></script>
		<script src="../js/base.js"></script>
		<script src="../js/common.js"></script>
		<style type="text/css">
			body{width:100%;height:auto;overflow-y:auto;min-height: 100%;}
			.mui-bar .mui-title{margin: 0 20px;}
			.mui-content{background: none;overflow: auto;}
			.mui-warpper{margin-top: 20px;}
			.myContent{margin:0 10px;padding-bottom:5px;background: #fff;border-radius: 10px;}
			.swiper-slide{text-align:center;font-size:1.2rem;color:#C5C4C4;vertical-align:middle;line-height:50px;height:50px;font-weight:600;}
			.swiper-slide-active{color:#F17746;font-size:2rem;}
			.swiper-button-next{right:0;float:left;width:10px;height:50px;background:transparent url(../img/charge/swiper-button-next.png) no-repeat right center;outline:none;}
			.swiper-button-prev{left:0;float:left;width:10px;height:50px;background:transparent url(../img/charge/swiper-button-prev.png) no-repeat left center;outline:none;}
			.swiper-slide span{text-align:center;font-size:1.2rem;color:#666;vertical-align:middle;line-height:35px;height:35px;width:35px;display:inline-block;font-weight:400;background-color:#F0F0F0;border-radius:25px;box-shadow:1px 1px 2px #888888;}
			.swiper-slide-active span{color:#FFFFFF;margin-top:-7px;font-size:1.6rem;height:42px;width:42px;line-height:42px;background-color:#F17746;font-weight:600;}
					
			.SockeBox{padding:0;margin-left:4%;margin-bottom: 10px;}
			.SockeBox span{display:block;float:left;width:16%;text-align:center;margin:0;padding:0;}
			.SockeBox span b{display:block;background:#F2F2F2;color: #666;margin: 5px;line-height:2.4rem;font-size:1.2rem;font-weight:500;border-radius:8px;box-shadow:1px 1px 2px #888888;}
			.SockeBox span.active b{background:#F17746;color:#fff;}
			.SockeBox span.disabled b{background:#EDEDED;color:#fff;}
			
			.timeBox{padding: 10px 15px;padding-top:0;}
			.timeBox span{display:block;float:left;width:33%;text-align:center;position:relative;}
			.timeBox span.active b{background:#F17746;color:#fff;}
			.timeBox span b{display:block;margin:5px;background:#F2F2F2;line-height:2.4rem;font-size:13px;font-weight:bold;border-radius:28px;color:#666;box-shadow:1px 1px 2px #888888;letter-spacing:1px;}
			.timeBox span i{left:4px;padding:0;width:24px;height:50px;position:absolute;}
			.timeBox span.promotion b{text-indent: 10px;}
			.timeBox span.promotion i{background:transparent url("../img/promotion.png") no-repeat left top;word-wrap:break-word;text-align:center;vertical-align:middle;letter-spacing:5px;font-size:12px;line-height:16px;font-weight:bold;color:#FFFFFF;}
			.timeBox span.promotion i em{margin-left:5px;margin-top:5px;width:12px;height:24px;float:left;font-style:normal;}			
					
			.progressBoxWrap{position:fixed;top:0;width:100%;height:100%;bottom:0;background:rgba(0,0,0,.3);z-index:9999;overflow:hidden;display: none;}
			.progressBox{background:#fff;width:80%;height:60%;margin:0 auto;margin-top:30%;border-radius:10px;overflow:hidden;}
			.progressBoxTitle{text-align:center;background:#EF7F35;padding:10px;color:#fff;}
			.stepBox{padding:20px;}
			.stepBox .stepItem{width:160px;margin:0 auto;padding:10px 0;position:relative;color:#666;font-size:.8rem;}
			.stepBox .stepItem span{display:block;position:absolute;height:25px;width:2px;background:#666;left:9px;top:28px;}
			.stepBox .stepItem i{display:inline-block;margin-right:5px;font-size:20px;vertical-align: top;}
			.fa-spin{-webkit-animation:fa-spin 2s infinite linear;animation:fa-spin 2s infinite linear;}
			.stepBox .stepSuccess{color:#009966;}
			.stepBox .stepSuccess span{background:#009966;}
			.stepBox .stepItem:last-child span{display:none;}
			@-webkit-keyframes fa-spin {
			  0% {
			    -webkit-transform: rotate(0deg);
			    transform: rotate(0deg);
			  }
			  100% {
			    -webkit-transform: rotate(359deg);
			    transform: rotate(359deg);
			  }
			}
			@keyframes fa-spin {
			  0% {
			    -webkit-transform: rotate(0deg);
			    transform: rotate(0deg);
			  }
			  100% {
			    -webkit-transform: rotate(359deg);
			    transform: rotate(359deg);
			  }
			}
						
			.h2-title{line-height: 40px;padding: 0 15px;text-align:left;font-weight:600;color:#454545;letter-spacing:1px;margin:0;}
			.h2-title span{font-size: 18px;}
			.chargingNotes{padding:5px 25px 0;margin-bottom: 0;font-size: 13px;}	
				
			.chargingPriceDesc{font-size: 13px;color: #333;padding:10px 25px 0;}
			.chargingPriceDesc .desc-right span{float: left;width: 50%;display: inline-block;text-align: left;}
			.chargingPriceDesc .desc-right span:nth-child(even){text-align: right;}
			
			.footer{position:fixed;width:100%;left:0;bottom:0;color:#fff;line-height:60px;height:60px;vertical-align:middle;-webkit-transform:translateZ(0);background:#FF7546;background:-moz-linear-gradient(top,#FF7546 0%,#F08200 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0%,#FF7546),color-stop(100%,#F08200));background:-webkit-linear-gradient(right,#FF7546 0%,#F08200 100%);background:-o-linear-gradient(right,#FF7546 0%,#F08200 100%);background:-ms-linear-gradient(right,#FF7546 0%,#F08200 100%);background:linear-gradient(to right,#FF7546 0%,#F08200 100%);}
			.footer .left{float:left;padding-left:15px;position:absolute;color:#fff;display:none;}
			.footer .left b{vertical-align:middle;position:relative;font-weight:400;}
			.footer .right{float:left;background:none;text-align:center;width:100%;border-left:none;border-radius:0;font-size:18px;font-weight:500;}
			
			.guide-wrapper{display:none;}
			.guide{position:absolute;left:0;top:0;width:100%;height:100%;float:left;background:#000000 no-repeat left top;background-size:contain;opacity:1;}
			.guide .close{width:15%;height:10%;float:right;cursor:pointer;}
			.guide1{background-image:url("../img/guide/1.png");z-index:10009;}
			.guide2{background-image:url("../img/guide/2.png");z-index:10008;}
			.guide3{background-image:url("../img/guide/3.png");z-index:10007;}
			.guide4{background-image:url("../img/guide/4.png");z-index:10006;}
			.guide5{background-image:url("../img/guide/5.png");z-index:10005;}
			.icon-richscan{font-size:22px;color: #fff;font-weight: bold;padding: 12px;position: relative;top: -1px;}
			.icon-richscan:after{content: '扫一扫';position: absolute;bottom: -5px;left: 0;font-size: 8px;font-weight: 100;color: #fff;width: 100%;text-align: center;}
			.content-bg{position: absolute; z-index: -1; width: 100%; height: 190px; float: left; top: 0;left: 0; background-color: #FF7F3E;}
		</style>
	</head>
<body style="background: #F7F7F7;">   
	<div class="content-bg"></div>
	
	<header class="header header-immersed mui-bar mui-bar-nav" style="background: none;">
		<a class="mui-go-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<h1 class="mui-title" onclick="openSearch()"><i class="iconfont icon-map"></i><span id="cd-title">定位中..</span><i class="mui-icon mui-icon-forward" style="font-size: 18px;"></i></h1>
		<a class="iconfont icon-richscan mui-icon-right-nav mui-pull-right" id="openBarcode"></a>
	</header>

	<div class="mui-content">
		<div class="mui-warpper">
			<div class="myContent box1">
				<div class="h2-title"><span>①</span> 选择桩号</div>
				<div class="selectZhuangHao" style="padding: 0;position: relative">
					<div id="swiperBox">
						<div class="swiper-container">
							<div class="swiper-wrapper">
								<div class="swiper-slide"><span>A</span></div>
								<div class="swiper-slide"><span>B</span></div>
								<div class="swiper-slide"><span>C</span></div>
								<div class="swiper-slide"><span>D</span></div>
								<div class="swiper-slide"><span>E</span></div>
								<div class="swiper-slide"><span>F</span></div>
								<div class="swiper-slide"><span>G</span></div>
								<div class="swiper-slide"><span>H</span></div>
								<div class="swiper-slide"><span>I</span></div>
								<div class="swiper-slide"><span>J</span></div>
								<div class="swiper-slide"><span>K</span></div>
								<div class="swiper-slide"><span>L</span></div>
								<div class="swiper-slide"><span>M</span></div>
								<div class="swiper-slide"><span>N</span></div>
							</div>
							<div class="swiper-button-next" tabindex="0" role="button" aria-label="Next slide"></div>
							<div class="swiper-button-prev" tabindex="0" role="button" aria-label="Previous slide"></div>
						</div>
					</div>
				</div>

				<div class="line" style="margin: 14px auto 0; width: 90%; height: 1px; color: whitesmoke; background: radial-gradient(#E0E0E0, #F0F0F0, #FFFFFF);"></div>

				<div class="h2-title"><span>②</span> 选择插座</div>
				<div class="SockeBox mui-clearfix" id="SocketList">
					<span class="disabled"><b>1</b></span>
					<span class="disabled"><b>2</b></span>
					<span class="disabled"><b>3</b></span>
					<span class="disabled"><b>4</b></span>
					<span class="disabled"><b>5</b></span>
					<span class="disabled"><b>6</b></span>
					<span class="disabled"><b>7</b></span>
					<span class="disabled"><b>8</b></span>
					<span class="disabled"><b>9</b></span>
					<span class="disabled"><b>10</b></span>
					<span class="disabled"><b>11</b></span>
					<span class="disabled"><b>12</b></span>
				</div>
			</div>

			<div class="myContent box2" style="margin-top: 15px;">
				<div class="h2-title"><span>③</span> 选择充电时长</div>
				
				<div class="timeBox mui-clearfix" id="TimeList">
					<span class="item"><b>充满自停</b></span>
				</div>
			</div>
			<!-- <p class="chargingNotes">注：大功率可能充不到所选小时</p> -->
			<div id="chargingPriceDesc" class="chargingPriceDesc">				
				
			</div>
		</div>
	</div>
	<footer id="footer" class="footer mui-clearfix">
		<div class="left">
			价格 : ￥<b class="priceBox" style="vertical-align: 0px;">0</b>
		</div>
		<div class="right" id="submitBtn">
			开始充电
		</div>
	</footer>
	
	<div class="progressBoxWrap">
		<div class="progressBox">
			<div class="progressBoxTitle">请求执行中</div>
			<div class="stepBox">
				<div class="stepItem stepSuccess">
					<i class="iconfont icon-check"></i>
					<span class="line"></span> 开始下单
				</div>
				<div class="stepItem">
					<i class="iconfont icon-refresh fa-spin"></i>
					<span class="line"></span> 校验设备
				</div>
				<div class="stepItem">
					<i class="iconfont icon-refresh fa-spin"></i>
					<span class="line"></span> 发送命令给充电桩
				</div>
				<div class="stepItem">
					<i class="iconfont icon-refresh fa-spin"></i>
					<span class="line"></span> 等待充电桩回复
				</div>
				<div class="stepItem">
					<i class="iconfont icon-refresh fa-spin"></i>
					<span class="line"></span> 赠送云钻
				</div>
				<div class="stepItem">
					<i class="iconfont icon-refresh fa-spin"></i>
					<span class="line"></span> 开启充电桩成功
				</div>
			</div>
		</div>
	</div>

	<div class="guide-wrapper">
		<div class="guide guide1" onclick="guideNext(this)">
			<div class="close" onclick="guideClose();stopEvt(event)"></div>
		</div>
		<div class="guide guide2" onclick="guideNext(this)">
			<div class="close" onclick="guideClose();stopEvt(event)"></div>
		</div>
		<div class="guide guide3" onclick="guideNext(this)">
			<div class="close" onclick="guideClose();stopEvt(event)"></div>
		</div>
		<div class="guide guide4" onclick="guideNext(this)">
			<div class="close" onclick="guideClose();stopEvt(event)"></div>
		</div>
		<div class="guide guide5" onclick="guideClose()"></div>
	</div>
	<!--插座模板-->
	<script type="text/html" id="SocketTmpl" >	
		{{each list as item index}}
			{{if item.status == 1}}
				<span class="item" data-id="{{item.id}}" onclick="clickSocket(this)"><b>{{item.code | parseInt}}</b></span>
			{{else}}
				<span class="disabled" data-id="{{item.id}}"><b>{{item.code | parseInt}}</b></span>
			{{/if}}
		{{/each}}
	</script>
	<!--充电时长模板-->
	<script type="text/html" id="TimeTmpl" >	
		{{each list as item index}}
			{{if item.state == 1}}	
				<span onclick="clickTime(this)" class="list-time {{if item.promotion}}promotion{{/if}}" data-id="{{item.id}}" data-time="{{item.defaultTime}}" data-state="{{item.state}}" data-money="{{item.price}}"><i><em>{{item.promotionRemark}}</em></i><b>充满自停</b></span>
			{{else}}
				{{if item.defaultTime > 60 }}
					<span onclick="clickTime(this)" class="list-time {{if item.promotion}}promotion{{/if}}" data-id="{{item.id}}" data-time="{{item.defaultTime}}" data-state="{{item.state}}" data-money="{{item.price}}"><i><em>{{item.promotionRemark}}</em></i><b>{{item.defaultTime/60 | formatNumber:'1'}}小时</b></span>
				{{else}}
					<span onclick="clickTime(this)" class="list-time {{if item.promotion}}promotion{{/if}}" data-id="{{item.id}}" data-time="{{item.defaultTime}}" data-state="{{item.state}}" data-money="{{item.price}}"><i><em>{{item.promotionRemark}}</em></i><b>{{item.defaultTime}}分钟</b></span>
				{{/if}}
			{{/if}}
		{{/each}}
	</script>
	<!--收费说明模板-->
	<script type="text/html" id="PriceTmpl" >		
		<div class="desc-left">
			<span>收费说明：</span>
		</div>
		<div class="desc-right mui-clearfix">
			{{each list as item index}}
				{{if index == list.length-1}}
					<span>{{item.price}}元/小时 ({{item.minEle}}w以上)</span>
				{{else}}
					<span>{{item.price}}元/小时 ({{item.minEle}}~{{item.maxEle}}w)</span>
				{{/if}}			
			{{/each}}
		</div>
	</script>
	
<script type="text/javascript">
	var swiper = null;
	var $addressTitle = $("#cd-title");	
	var geolocationGroup = null;  //用户定位信息
	var inputCdzID = null;
	var groupID    = null;		  //当前选择的片区
	var addresses  = null;		  //片区地址
	var scanGroup  = null;   	  //扫一扫的片区
	var scanCdzID  = null;		  //扫一扫的充电桩ID	
	var priceDesc  = [];	      // 价格描述
	mui.init();
	plusUtils.pageReady(function(){
		initSwiper();
		checkLogin();
		plusUtils.locate.getCurrentPosition();
		geolocationGroup = JSON.parse(plusUtils.Storage.getItem("geolocationGroup"));
		getChargingGroup();	
	});
	document.addEventListener("netchange", function () {
		getChargingGroup();
	});
	plusRefresh(dataRefresh);	
	// 刷新页面
	function dataRefresh() {
		priceDesc  = [];		
		getChargingGroup();
	}

	//初始化选择桩号滑动效果	 
	function initSwiper() {
		swiper = new Swiper('.swiper-container', {
			slidesPerView: 6,
			spaceBetween: 5,
			centeredSlides: true,
			slideToClickedSlide: true,
			spaceBetween: '3%',
			navigation: {
				nextEl: '.swiper-button-next',
				prevEl: '.swiper-button-prev'
			},
			on: {
				transitionEnd: function() {
					changeSelectStake();
				}
			}
		});
	}
	//初始化根据定位获取最近的充电桩地址
	function getChargingGroup(){
		groupID = plusUtils.Storage.getItem("chargingGroupId");
		addresses = plusUtils.Storage.getItem("addresses");
		inputCdzID = plusUtils.Storage.getItem("inputCdzID");
		if(vaildeParam(groupID)){
			console.log("## 选中充电桩地址：" + addresses + " 片区编号：" + groupID)
			$addressTitle.text(addresses);
			getChargingByGroupID(groupID);
			getChargingGroupPrice(groupID);
		}else{
			if(!vaildeParam(geolocationGroup)){
				layer.msg("定位失败,请手动输入充电桩地址!");
				plusUtils.locate.getCurrentPosition();
				geolocationGroup = JSON.parse(plusUtils.Storage.getItem("geolocationGroup"));
				return;
			}
			var params = {
				uuid:uuid,
				latitude:geolocationGroup.latitude,
				longitude:geolocationGroup.longitude,
				useLocation:false
			}
			postJSON(API_URL.GetChargingGroup,params,function(res){
				if(res.code == "0"){
					addresses = res.data.chargingGroup.name;
					groupID = res.data.chargingGroup.code;
					$addressTitle.text(addresses);					
					getChargingByGroupID(groupID);
					getChargingGroupPrice(groupID);
					// res.data.needGuide = true;
					if(res.data.needGuide){
						guide();
					}
				}
			},true)
		}
	}
	//根据片区id获取充电桩桩号
	function getChargingByGroupID(id){
		if(!vaildeParam(id)) {
			layer.msg("没有获取到片区");
			return;
		}
		console.log("## 片区id:"+id)
		postJSON(API_URL.ApiGetChargingByGroupID, {"id": id}, function(res) {
			if("0" == res.code) {
				var data = res.data;
				if(data.length == 0) {
					layer.msg("暂无充电桩");
					$(".swiper-wrapper").html('<div class="swiper-slide">无</div>');
					swiper.update();
				} else {
					getChargingStakeList(data);
				}
			} else {
				layer.msg(res.msg);
			}
		},true);
	}
	//充电桩桩号列表
	function getChargingStakeList(data) {
		var html = '';
		$.each(data, function(index, item) {
			var code = item.code;
			var shellId = item.shellId;
			html += '<div data-code="' + code + '" data-id="' + item.id + '" class="swiper-slide"><span>' + shellId.substring(0, 1) + '</span></div>';
		})
		$(".swiper-wrapper").html(html);
		swiper.update();
		if(vaildeParam(scanCdzID)) {
			var index = $(".swiper-slide[data-id='" + scanCdzID + "']").index();
			swiper.slideToLoop(index);
		};
		if(vaildeParam(inputCdzID)) {
			var index = $(".swiper-slide[data-id='" + inputCdzID + "']").index();
			swiper.slideToLoop(index);
		};
		changeSelectStake();
	}
	//选择充电桩桩号获取插座
	function changeSelectStake() {
		var $StakeActive = $(".swiper-slide-active");		
		var StakeCode = $StakeActive.attr("data-code");
		var StakeText = $StakeActive.text();
		if(!vaildeParam(StakeCode)) {
			return;
		}
		console.log("## 选中充电桩桩号:" + StakeText);
		getChargingSocketList(StakeCode);
	}
	//获取充电桩插座列表
	function getChargingSocketList(StakeCode) {
		if(!vaildeParam(StakeCode)) {
			return;
		}
		var Html = "";
		postJSON(API_URL.ApiChargingSocketListByCode, {"code": StakeCode}, function(res) {
			if("0" == res.code) {
				var list = res.data.sort(compare('code'));
				var data = {'list':list};
				Html = template('SocketTmpl', data);
				$('#SocketList').html(Html);					
			} else {
				layer.msg(res.msg);
			}
		},true)
	}
	//排序
	function compare(property) {
		return function(a, b) {
			var value1 = parseFloat(a[property]);
			var value2 = parseFloat(b[property]);
			return value1 - value2;
		}
	}
	//插座点击事件
	function clickSocket(that){
		$(that).addClass('active').siblings().removeClass('active');
	}

	//获取充电桩充电时长	
	function getChargingGroupPrice(groupID) {
		if(!vaildeParam(groupID)) {
			layer.msg("没有获取到片区");
			return;
		}
		var params = {
			"groupID": groupID,
			"uuid": uuid
		}
		var Html = "";
		postJSON(API_URL.ApiCharginGetPriceListByGroupID,params, function(res) {
			if("0" == res.code) {
				var data = {'list':res.data};
				Html = template('TimeTmpl', data);
				$('#TimeList').html(Html);
				$('#footer').find('.left').hide();
				$('#chargingPriceDesc').html('');
			} else {
				layer.msg(res.msg);
			}
		})
	}
	//充电时长点击事件
	function clickTime(that){		
		var state = $(that).attr('data-state');
		var price = $(that).attr("data-money");
		var priceId = $(that).attr("data-id");
		console.log(state,price,priceId)
		$(that).addClass('active').siblings().removeClass('active');
		$(".priceBox").text(price);
		if(state == '1' || state == '2') {
			if(!priceDesc[priceId]) {
				postJSON(API_URL.ApiChargingPriceDesc, {"chargingPriceId": priceId}, function(res) {
					if(res.code == '0') {
						showPriceDesc(res.data,state);
						priceDesc[priceId] = res.data;
					}
				},true);
			} else {
				showPriceDesc(priceDesc[priceId],state);
			}
			$('#footer').find('.left').hide();
		} else {
			$(".mui-warpper").height("auto");
			$('#footer').find('.left').show();
			$('#chargingPriceDesc').html('');
		}
	};
	//显示价格设置
	function showPriceDesc(data,state) {
		var Html = '';
		var data = {'list':data};
		Html = template('PriceTmpl', data);
		$('#chargingPriceDesc').html(Html);
		var h1 = $('.box1').outerHeight(),
			h2 = $('.box2').outerHeight(),
			h3 = $('.chargingNotes').outerHeight(),
			h4 = $('.chargingPriceDesc').outerHeight();
		var Height = h1 + h2 + h3 + h4 + 20 + 60;
		if(state == '1' || state == '2') {
			$(".mui-warpper").height(Height);
		}
	}
	$("#submitBtn").click(function() {
		if(!vaildeParam(groupID)) {
			layer.msg("没有获取到片区");
			return;
		}
		var $swiperSlideActive = $(".swiper-slide-active");
		if($swiperSlideActive.length <= 0) {
			layer.msg("还没选择桩号");
			return;
		}
		var cdzCode = $swiperSlideActive.attr("data-code");
		if(!vaildeParam(cdzCode)) {
			layer.msg("还没选择桩号");
			return;
		}
		var $cz = $(".SockeBox .active");
		if($cz.length == 0) {
			layer.msg("你还没选择插座");
			return;
		}
		var zcID = $cz.attr("data-id");
		if(!vaildeParam(zcID)) {
			layer.msg("你还没选择插座");
			return;
		}
		var $time = $('.timeBox .active');
		if($time.length == 0) {
			layer.msg("你还没选择时间");
			return;
		}
		showLoadingSuccess();
		var data = {
			"uuid": uuid,
			"zcID": zcID,
			"chargingGroupPriceId": $time.attr("data-id"),
			"minutes": $time.attr('data-time'),
			"method": $time.attr('data-state')
		}
		var url = API_URL.ApiDeviceCommandSendChargeCommand;
		postJSON(url, data, shargeSubmitResponse,true);
	})
	//下发充电
	function shargeSubmitResponse(res) {
		if("0" == res.code) {
			setLoadingSuccess();	
			if(res.remark){
				layer.msg(remark);
			}else{
				var msg = '充电成功';
				if(res.givePoints > 0) {
					msg += " , 充电结束可获得云钻";
				}
				layer.msg(msg);
			}		
			setTimeout(function() {
				initLoadingSuccess();
				openWebview('chargeing.html',false,true,{'orderNo':res.data.sn});
			}, 1500)
		} else {
			initLoadingSuccess();
			if('未知错误' == res.msg) {
				layer.msg("请求超时");
			} else {
				layer.msg(res.msg);
			}
		}
	}
	var loadingInterval = null;
	function showLoadingSuccess() {
		$('.progressBoxWrap').css("display", 'block')
		loadingInterval = setInterval(function() {
			var hasChange = false;
			var $stepItems = $(".progressBox .stepItem");
			$.each($stepItems, function(index, item) {
				if(index < $stepItems.length - 1) {
					if(!$(item).hasClass('stepSuccess') && !hasChange) {
						$(item).addClass('stepSuccess');
						$(item).find("i").removeClass('icon-refresh').removeClass('fa-spin').addClass('icon-check');
						hasChange = true;
					}
				}
			})
			if(!hasChange) {
				clearLoadingInterval(loadingInterval);
			}
		}, 1000);
	}

	function clearLoadingInterval() {
		if(vaildeParam(loadingInterval)) {
			clearInterval(loadingInterval);
		}
	}

	/**
	 * 初始化充电进度框
	 */
	function initLoadingSuccess() {
		clearLoadingInterval(loadingInterval);
		$(".progressBoxWrap").css("display", 'none');
		$(".progressBox .stepItem").removeClass('stepSuccess');
		$(".progressBox .stepItem i").addClass('icon-refresh').addClass('fa-spin').removeClass('icon-check');
	}

	/**
	 * 设置充电进度框为成功
	 */
	function setLoadingSuccess() {
		clearLoadingInterval(loadingInterval);
		$(".progressBox .stepItem").addClass('stepSuccess');
		$(".progressBox .stepItem i").removeClass('icon-refresh').removeClass('fa-spin').addClass('icon-check');
	}
	// 打开搜索页面
	function openSearch(){
		openWebview('selectChargeSearch.html',true,true);
	}
	// 打开自定义扫描界面
	mui('body').on('tap',"#openBarcode",function(){
		openWebview('scanBarcode.html',false,true,{formpage:'cdzno'});		
	})
	/**
	 * 扫一扫接口
	 * @param type
	 * @param result
	 * @param file
	 */
	function scaned(type, result, file) {
		if(!vaildeParam(result)) {
			return;
		}	
// 		if(type == 'QR' && result.indexOf("?shell=") != -1){
// 			result = result.split("=")[1];
// 			if(!vaildeParam(result)){
// 				layer.msg("请扫描充电桩二维码下的条形码");
// 				return;
// 			}
// 		}
		postJSON(API_URL.ApiChargingInfoByShellId, {'shellId': result}, function(res) {
			if('0' == res.code) {
				scanCdzID = res.data.id;
				scanGroup = res.data.groupId;
				//如果存在扫一扫的片区数据，默认显示扫一扫的数据
				if(vaildeParam(scanGroup)) {
					$addressTitle.text(scanGroup.name);
					groupID = scanGroup.id;
					inputCdzID = null;
					getChargingByGroupID(groupID);
					getChargingGroupPrice(groupID);
					plusUtils.Storage.setItem("chargingGroupId",groupID);
					plusUtils.Storage.setItem("addresses",scanGroup.name);					
				}			
			} else {
				layer.msg(res.msg)
			}
		})
	}
	function guide() {
		$('.guide-wrapper').css('display', 'block');
	}
	function guideNext(self) {
		var t = setTimeout(function() {
			$(self).css('display', 'none');
			window.clearTimeout(t);
		}, 200);
	}
	function guideClose() {
		$('.guide-wrapper').css('display', 'none');
	}
	function stopEvt(e) {
		e.stopPropagation(); //阻止点击事件向上冒泡
	}
</script>
</body>
</html>