<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="misapplication-tap-highlight" content="no"/>
    <meta name="HandheldFriendly" content="true"/>
    <meta name="MobileOptimized" content="320"/>
    <title>我的IC卡</title>
    <link rel="stylesheet" href="../css/iconfont.css">
    <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
    <link rel="stylesheet" href="../css/bootstrap.min.css" type="text/css" charset="utf-8"/>
    <link rel="stylesheet" href="../plugins/layer/theme/default/layer.css" type="text/css" charset="utf-8"/>
    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../plugins/layer/layer.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/base.js"></script>

    <style type="text/css">
        .adBox{
            margin-top: 15px;
        }
        .dataNormal {
			margin-top: 80px;
			font-size: 24px;
            color: #666666;
            /*line-height: 55px;*/
		}
		.dataNormal .left{
            float: left;
        }
        .dataNormal .left span{
            display: inline-block;
            line-height: 3rem;
        }
        .dataNormal .right {
        	width: 70%;
            float: right;
        }
		#iccardInput {
			/*margin-top: 20px;*/
			-webkit-user-select: text;
			text-align:left;
			border: 0px;
			border-radius: 0;
			font-size: 16px;
			width: 100%;
			outline: none;
			line-height: 3rem;
			border-bottom: #D8D8D8 solid 1px;
		}
		
		footer {
            margin: 0 2rem;
			height: 100px;
			position: fixed;
			bottom: 0;
		}
        #submitBtn {
            display: block;
            width: 100%;
            margin-top: 15px;
        }
        #submitBtn img {
        	width: 100%;
        }
    </style>
</head>
<body>

    <header id="header2">
        <div class="headInner">
            <div class="left" id="back"  onclick="back()" ><img src="../img/app_back.png" /></div>
            <div class="right">&nbsp;</div>
            <div style="clear: both"></div>
        </div>
    </header>

    <div class="myContent" style="padding-top: 70px">
        <h1 class="pageBigTitle">绑定IC卡</h1>

        <div class="dataItem dataNormal">
        	<div class="left">
                <div class="detialInfo">
                    <span class="span1">卡号</span>
                </div>
            </div>
            <div class="right">
            	<input type="number" id="iccardInput" placeholder="请输入10位数的IC卡卡号" pattern="\d*" />
            </div>
            <div style="clear: both"></div>
            <div style="clear: both"></div>
        </div>
    </div>
    
    <footer>
    	<div id="submitBtn">
    		<img src="../img/app_yes_btn.png">
    	</div>
    </footer>

    <script type="application/javascript">

        var ws=null;
        // 处理沉浸式状态栏
        var topoffset=0;
        var ms=(/Html5Plus\/.+\s\(.*(Immersed\/(\d+\.?\d*).*)\)/gi).exec(navigator.userAgent);
        if(ms&&ms.length>=3){
            topoffset=parseFloat(ms[2]);
        }

        if(window.plus){
            pagePlusReady();
        }else{
            document.addEventListener('plusready',pagePlusReady,false);
        }

        function pagePlusReady(){

            uploadLoginInfo();

            checkLogin();

            getUserInfo();
			
            ws=plus.webview.currentWebview();
            if(plus.navigator.isImmersedStatusbar()){// 兼容沉浸式状态栏模式
                topoffset=Math.round(plus.navigator.getStatusbarHeight());
            }
            ws.setPullToRefresh({support:true,style:'circle',offset:topoffset+45+'px'},onRefresh);

        }

        // 刷新页面
        function onRefresh(){
            getUserInfo();
            ws.endPullToRefresh();
        }

        // 获取用户信息
        function getUserInfo(){
            var uuid = plus.storage.getItem("uuid");
            if(vaildeParam(uuid)){
                postJSON(API_URL.ApiMemberInfo,{"uuid":uuid},function(res){
                    if("0" == res.code){
                        var money = res.data.totalMoney;
                        console.log("## money ## : "+money)
                        money= parseFloat(money);
                        money = parseFloat(money.toFixed(2));
                        $("#moneyBox").text(money);

                        var points = res.data.points;
                        if(!vaildeParam(points)){
                            points = 0;
                        }
                        console.log("## points ## : "+points)
                        points= parseFloat(points);
                        points = parseFloat(points.toFixed(2));
                        $("#pointsBox").text(points);


                    }else{
                        layer.msg(res.msg);
                        clearLogin();
                        clicked("page/login.html");
                    }
                })
            }
        }
		
		function icCardbinding() {
			var cardid = $('#iccardInput').val();
			if (!/^\d{10}$/.test(cardid)) {
				layer.msg('请输入10位数的IC卡卡号');
				return;
			}
			
			var uuid = plus.storage.getItem("uuid");
			postJSON(API_URL.ApiMemberCardBindingCard, {
				"uuid" : uuid,
				"iccard" : cardid
			}, function(res) {
				if (res.code == '0') {
					layer.msg('绑定成功', function() {
						var ws=plus.webview.currentWebview();
	                    var wo = ws.opener();
	                    wo.evalJS('getList()');
	                    
	                    back();
					});
				} else {
					layer.msg(res.msg);
				}
			});
		}
		document.getElementById('submitBtn').addEventListener('click', icCardbinding);
    </script>


</body>

</html>